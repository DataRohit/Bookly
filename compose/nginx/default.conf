# Define an upstream server group named 'backend' for the application backend
upstream backend {
    server backend:8000;  # Application backend address and port
}

# Define an upstream server group named 'minio' for the MinIO server
upstream minio {
    server minio:9000;  # MinIO server address and port
}

server {
    listen 80;  # Listen on port 80 for incoming HTTP requests
    server_name bookly;  # Add this line to match the hostname used in the SSH tunnel
    client_max_body_size 20M;  # Set maximum allowed client request body size to 20MB

    error_log /var/log/nginx/error.log error;  # Main error log file

    # Set proxy headers to pass client request information to the backend servers
    proxy_set_header Host $http_host;  # Changed from $host to $http_host
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1; # Use HTTP/1.1 for proxy connections
    proxy_buffering off; # Disable proxy buffering

    # WebSocket support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Location block for the API
    location /api/v1/ {
        proxy_pass http://backend/api/v1/;  # Proxy requests to the application backend
        access_log /var/log/nginx/backend_access.log;  # Access log file for the API
        error_log /var/log/nginx/backend_error.log error;  # Error log file for the API
    }

    # Location block for the swagger schema
    location /swagger/schema/ {
        proxy_pass http://backend/api/v1/openapi.json;  # Proxy requests to the application backend
        access_log /var/log/nginx/swagger_access.log;  # Access log file for the swagger schema
    }

    # Location block for the swagger documentation
    location /swagger/redoc/ {
        proxy_pass http://backend/api/v1/redoc/;  # Proxy requests to the application backend
        access_log /var/log/nginx/swagger_access.log;  # Access log file for the swagger documentation
    }

    # Location block for the swagger documentation
    location /swagger/docs/ {
        proxy_pass http://backend/api/v1/docs/;  # Proxy requests to the application backend
        access_log /var/log/nginx/swagger_access.log;  # Access log file for the swagger documentation
    }

    # Location block for MinIO storage
    location /minio/storage/bookly/ {
        proxy_pass http://minio/bookly/;  # Proxy requests to the MinIO server
        access_log /var/log/nginx/minio_access.log;  # Access log file for MinIO
        error_log /var/log/nginx/minio_error.log error;  # Error log file for MinIO
    }
}
